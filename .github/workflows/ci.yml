name: CI

on:
  pull_request:
    branches: [ main, master ]

jobs:
  lint-client:
    name: Lint Client
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install dependencies
      working-directory: ./clingy-client/ui
      run: bun install

    - name: Run ESLint
      working-directory: ./clingy-client/ui
      run: bun run lint

    - name: TypeScript check
      working-directory: ./clingy-client/ui
      run: bunx tsc --noEmit

    - name: Lint clingy-client/api
      uses: golangci/golangci-lint-action@v9
      with:
        version: 'v2.6'
        working-directory: ./clingy-client/api

  lint-server:
    name: Lint Server
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.5'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: golangci-lint clingy-server
      uses: golangci/golangci-lint-action@v9
      with:
        version: 'v2.6'
        working-directory: ./clingy-server

  build-server:
    name: Build Server
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        arch: [amd64, arm64]
        exclude:
          - os: windows-latest
            arch: arm64
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.5'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Build clingy-server
      working-directory: ./clingy-server
      env:
        GOOS: ${{ runner.os == 'ubuntu-latest' && 'linux' || runner.os == 'windows-latest' && 'windows' || 'darwin' }}
        GOARCH: ${{ matrix.arch }}
      run: |
        EXT=""
        if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi
        go build -o clingy-server-${GOOS}-${GOARCH}${EXT} .

    - name: Upload server binaries
      uses: actions/upload-artifact@v4
      with:
        name: clingy-server-${{ runner.os }}-${{ matrix.arch }}
        path: clingy-server/clingy-server-*
